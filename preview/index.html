<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview - iziWebCMS</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        body { margin: 0; padding: 0; }
        .preview-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div class="preview-loader" id="loader">
        <div>Chargement de la prévisualisation...</div>
    </div>
    <script>
        const PREVIEW_STORAGE_KEY = 'iziwebcms_preview_template';
        
        // Récupérer le slug depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const currentSlug = urlParams.get('slug') || 'default';
        
        window.addEventListener('DOMContentLoaded', () => {
            const storageKey = `${PREVIEW_STORAGE_KEY}_${currentSlug}`;
            
            // Récupérer le template depuis localStorage
            const templateData = localStorage.getItem(storageKey);
            
            if (templateData) {
                try {
                    const { html, metadata } = JSON.parse(templateData);
                    
                    // Parser le HTML pour extraire head et body
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Supprimer le loader
                    document.querySelector('.preview-loader')?.remove();
                    
                    // Remplacer les éléments du head
                    if (doc.head) {
                        const currentHead = document.head;
                        const newHeadElements = Array.from(doc.head.children);
                        
                        // Ajouter les éléments du template au head (CSS, scripts, etc.)
                        newHeadElements.forEach(element => {
                            // Ne pas dupliquer les scripts déjà présents (comme htmx)
                            if (element.tagName === 'SCRIPT' && element.src) {
                                const existing = document.querySelector(`script[src="${element.src}"]`);
                                if (existing) {
                                    return; // Skip si déjà présent
                                }
                            }
                            // Ne pas dupliquer les styles déjà présents
                            if (element.tagName === 'LINK' && element.rel === 'stylesheet' && element.href) {
                                const existing = document.querySelector(`link[href="${element.href}"]`);
                                if (existing) {
                                    return; // Skip si déjà présent
                                }
                            }
                            // Cloner l'élément avec tous ses attributs et son contenu
                            const cloned = element.cloneNode(true);
                            currentHead.appendChild(cloned);
                        });
                        
                        // Mettre à jour le titre si disponible
                        if (metadata && metadata.title) {
                            document.title = metadata.title + ' - Preview';
                        }
                        
                        // Mettre à jour les meta tags si disponibles
                        if (metadata && metadata.metaDesc) {
                            let metaDesc = document.querySelector('meta[name="description"]');
                            if (!metaDesc) {
                                metaDesc = document.createElement('meta');
                                metaDesc.setAttribute('name', 'description');
                                currentHead.appendChild(metaDesc);
                            }
                            metaDesc.setAttribute('content', metadata.metaDesc);
                        }
                    }
                    
                    // Remplacer le body
                    if (doc.body) {
                        document.body.innerHTML = doc.body.innerHTML;
                    } else {
                        // Fallback: injecter directement dans le body si pas de structure HTML complète
                        document.body.innerHTML = html;
                    }
                    
                    // Modifier tous les liens HTMX pour qu'ils pointent vers preview.html avec le slug
                    const allLinks = document.querySelectorAll('[hx-get], [hx-post], [hx-put], [hx-delete]');
                    allLinks.forEach(link => {
                        const hxGet = link.getAttribute('hx-get');
                        const hxPost = link.getAttribute('hx-post');
                        const hxPut = link.getAttribute('hx-put');
                        const hxDelete = link.getAttribute('hx-delete');
                        
                        // Modifier hx-get
                        if (hxGet && !hxGet.startsWith('http') && !hxGet.startsWith('/api/') && !hxGet.startsWith('/admin') && !hxGet.startsWith('/preview')) {
                            const newUrl = `/preview?slug=${encodeURIComponent(currentSlug)}&path=${encodeURIComponent(hxGet)}`;
                            link.setAttribute('hx-get', newUrl);
                        }
                        
                        // Modifier hx-post
                        if (hxPost && !hxPost.startsWith('http') && !hxPost.startsWith('/api/') && !hxPost.startsWith('/admin') && !hxPost.startsWith('/preview')) {
                            const newUrl = `/preview?slug=${encodeURIComponent(currentSlug)}&path=${encodeURIComponent(hxPost)}`;
                            link.setAttribute('hx-post', newUrl);
                        }
                        
                        // Modifier hx-put
                        if (hxPut && !hxPut.startsWith('http') && !hxPut.startsWith('/api/') && !hxPut.startsWith('/admin') && !hxPut.startsWith('/preview')) {
                            const newUrl = `/preview?slug=${encodeURIComponent(currentSlug)}&path=${encodeURIComponent(hxPut)}`;
                            link.setAttribute('hx-put', newUrl);
                        }
                        
                        // Modifier hx-delete
                        if (hxDelete && !hxDelete.startsWith('http') && !hxDelete.startsWith('/api/') && !hxDelete.startsWith('/admin') && !hxDelete.startsWith('/preview')) {
                            const newUrl = `/preview?slug=${encodeURIComponent(currentSlug)}&path=${encodeURIComponent(hxDelete)}`;
                            link.setAttribute('hx-delete', newUrl);
                        }
                    });
                    
                    // Modifier aussi les attributs href pour la navigation normale
                    const hrefLinks = document.querySelectorAll('a[href]');
                    hrefLinks.forEach(link => {
                        const href = link.getAttribute('href');
                        if (href && !href.startsWith('http') && !href.startsWith('#') && !href.startsWith('/api/') && !href.startsWith('/admin') && !href.startsWith('mailto:') && !href.startsWith('tel:') && !href.startsWith('/preview')) {
                            const newHref = `/preview?slug=${encodeURIComponent(currentSlug)}&path=${encodeURIComponent(href)}`;
                            link.setAttribute('href', newHref);
                        }
                    });
                    
                    // Intercepter les requêtes HTMX pour rediriger vers preview
                    document.body.addEventListener('htmx:configRequest', (event) => {
                        const requestPath = event.detail.path;
                        
                        // Si ce n'est pas déjà une requête vers preview et pas une API/admin
                        if (!requestPath.startsWith('/preview') && 
                            !requestPath.startsWith('/api/') && 
                            !requestPath.startsWith('/admin')) {
                            
                            // Rediriger vers preview avec le slug et le path
                            const newPath = `/preview?slug=${encodeURIComponent(currentSlug)}&path=${encodeURIComponent(requestPath)}`;
                            event.detail.path = newPath;
                        }
                    });
                    
                    // Initialiser HTMX après l'injection
                    if (typeof htmx !== 'undefined') {
                        htmx.process(document.body);
                    }
                } catch (e) {
                    document.body.innerHTML = `
                        <div style="padding: 2rem;">
                            <h1>Erreur</h1>
                            <p>${e.message}</p>
                        </div>
                    `;
                }
            } else {
                // Afficher un message si aucun template
                document.body.innerHTML = `
                    <div style="padding: 2rem; text-align: center;">
                        <h1>Aucun template trouvé</h1>
                        <p>Ouvrez l'IDE et sauvegardez un template pour le prévisualiser.</p>
                        <p>Slug recherché: <code>${currentSlug}</code></p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>

